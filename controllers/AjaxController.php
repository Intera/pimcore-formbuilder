<?phpuse Formbuilder\Controller\Action;use Formbuilder\Model\Form;use Formbuilder\Lib\Frontend as FormFrontEnd;use Formbuilder\Lib\Mailer;class Formbuilder_AjaxController extends Action{    public $languages = null;    public function parseAction()    {        $formId = $this->_getParam('_formId');        $locale = $this->_getParam('_language');        $templateId = $this->_getParam('_mailTemplate');        $responseId = $this->_getParam('_responseTemplate');        $valid = false;        $redirect = false;        $message = '';        $validationData = false;        $mainList = new Form();        $formData = $mainList->getById($formId);        if ($formData instanceof Form) {            $frontendLib = new FormFrontEnd();            $form = $frontendLib->getForm($formData->getId(), $locale, true);            $frontendLib->addDefaultValuesToForm(                $form,                [                    'formId' => $formId,                    'locale' => $locale,                    'mailTemplate' => $templateId,                    'responseTemplate' => $responseId,                ]            );            $params = $frontendLib->parseFormParams($this->getAllParams(), $form);            $formValid = true;            $valid = false;            if ($frontendLib->hasRecaptchaV2()) {                $formValid = $form->isValid($params, $frontendLib->getRecaptchaV2Key());            }            if ($formValid === true) {                $valid = $form->isValid($params);                $errorCount = 0;                // Related issues:                // http://framework.zend.com/issues/browse/ZF-12159                // http://framework.zend.com/issues/browse/ZF-10279                // http://framework.zend.com/issues/browse/ZF-12189                // Fix for $_FILES issue                foreach ($form->getElements() as $elem) {                    if ($elem->hasErrors()) {                        $errorCount++;                    }                    if ($elem instanceof Zend_Form_Element_File && !isset(                            $_FILES[$elem->getName()]                        ) && $elem->hasErrors()) {                        if ($elem->isRequired()) {                            $translator = $form->getTranslator();                            $message = $translator->translate("Value is required and can't be empty");                            $elem->clearErrorMessages();                            $elem->setTransferAdapter('Http'); // reset any errors that may be on the transfer adapter                            $elem->addError($message);                        } else {                            $elem->clearErrorMessages();                            $elem->setTransferAdapter('Http'); // reset any errors that may be on the transfer adapter                            $errorCount--;                        }                    }                }                $valid = ($errorCount == 0);            }            if ($valid) {                $assets = [];                $folder = WebsiteSetting::getByName('jobDocuments_path');                $parentId = $folder->getData();                foreach ($_FILES as $content) {                    if (is_array($content['name'])) {                        // TODO: multiple files sent                    } else {                        $filename = strtolower($content['name']);                        $data = file_get_contents($content['tmp_name']);                        $asset = \Pimcore\Model\Asset::create(                            $parentId,  //Parent ID                            [                                "filename" => $filename,                                "data" => $data,                                "userOwner" => 1,                                "userModification" => 1,                            ]                        );                        $asset->save();                        $assets[] = $asset;                    }                }                if ($templateId !== null) {                    $send = Mailer::sendForm($templateId, ['data' => $form->getValues()], $assets);                    if ($send === true) {                        $return = $this->afterSend($responseId);                        $valid = $return['valid'];                        $redirect = $return['redirect'];                        $message = $valid === false ? $return['message'] : $return['html'];                    }                }                foreach ($assets as $asset) {                    $asset->delete();                }            } else {                $validationData = $form->getMessages();            }        }        $this->_helper->json(            [                'success' => $valid,                'message' => $message,                'validationData' => $validationData,                'redirect' => $redirect,            ]        );    }    private function afterSend($responseId)    {        $redirect = false;        $error = false;        $successMessage = '';        $statusMessage = '';        $afterSuccess = \Pimcore\Model\Document::getById($responseId);        //get the content from a snippet        if ($afterSuccess instanceof \Pimcore\Model\Document\Snippet) {            $params['document'] = $afterSuccess;            if ($this->view instanceof \Pimcore\View) {                try {                    $successMessage = $this->view->action(                        $afterSuccess->getAction(),                        $afterSuccess->getController(),                        $afterSuccess->getModule(),                        $params                    );                } catch (\Exception $e) {                    $error = true;                    $statusMessage = $e->getMessage();                }            }        } //it's a redirect!        else {            if ($afterSuccess instanceof \Pimcore\Model\Document) {                $redirect = true;                $successMessage = $afterSuccess->getFullPath();            } //it's just a string!            else {                if (is_string($afterSuccess)) {                    $successMessage = $afterSuccess;                }            }        }        return [            'valid' => $error === false,            'message' => $statusMessage,            'redirect' => $redirect,            'html' => $successMessage,        ];    }}